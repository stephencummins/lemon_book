# The Lemon Book - Project Documentation

## Project Overview
"The Lemon Book" is a political book about liberalism published in multiple formats. The project uses markdown source files that are converted into PDF, EPUB, DOCX, ODT, RTF, and HTML formats using Pandoc.

## Repository Structure
```
/
├── *.md                    # Chapter markdown files (00-18)
├── scripts/
│   ├── build_book.sh      # Main build script
│   ├── metadata.yaml      # Book metadata (title, author, etc.)
│   └── PDF_BUILD_ORDER.md # Chapter ordering
├── images/                 # Chapter images (PNG format)
├── .gitignore             # Excludes generated files
├── .git/hooks/post-commit # Auto-build on commit
└── AUTOMATION.md          # Documentation

Generated files (NOT in git):
├── lemon_book.pdf (95M)
├── lemon_book.epub (51M)
├── lemon_book.docx (51M)
├── lemon_book.odt (51M)
├── lemon_book.rtf (101M)
└── lemon_book.html (392K)
```

## Chapter Files (in order)
1. `00_front_matter.md` - Title page, dedication
2. `00_introduction.md` - Introduction
3. `01_enlightenment_roots.md` - Historical context
4. `02_classical_liberalism.md` - Liberal philosophy
5. `03_build_houses_full.md` - Housing policy
6. `04_Pt1_mental_health_full.md` - Mental health
7. `04_Pt2_Reclaiming_Healthcare.md` - Healthcare
8. `05_capitalism_conscience.md` - Economic policy
9. `06_every_vote_counts.md` - Electoral reform
10. `07_europe_complicated.md` - European relations
11. `08_immigration_conversations.md` - Immigration
12. `09_green_growth.md` - Environmental policy
13. `10_technology_good.md` - Technology policy
14. `11_right_education.md` - Education
15. `12_your_rights_choices.md` - Individual rights
16. `13_rights_modern_age.md` - Digital rights
17. `14_tomorrows_tyranny.md` - Authoritarianism
18. `15_guest_voices.md` - Guest contributions
19. `16_cooption_language.md` - Language/framing
20. `17_reclaiming_liberalism.md` - Conclusion
21. `18_Conclusion.md` - Final thoughts
22. `bibliography.md` - References
23. `book_index_with_pages.md` - Index
24. `colophon.md` - Publication info

## Build System

### Automated Workflow
- **Post-commit hook**: `.git/hooks/post-commit`
- Automatically runs `UPLOAD_TO_R2=true bash scripts/build_book.sh` after every commit
- Generates all formats and uploads to Cloudflare R2

### Manual Build Commands
```bash
# Build and upload to Cloudflare R2
UPLOAD_TO_R2=true bash scripts/build_book.sh

# Build only (no upload)
bash scripts/build_book.sh
```

### Build Process (scripts/build_book.sh)
1. Assembles chapters in order from `CHAPTERS` array
2. Generates PDF using XeLaTeX (print-quality, uncompressed images)
3. Generates EPUB, DOCX, ODT, HTML, RTF formats
4. If `UPLOAD_TO_R2=true`, uploads all files to Cloudflare R2

### Cloudflare R2 Storage
- Bucket: `lemon-book`
- Path: `book/`
- Tool: `wrangler` CLI

## Git Configuration

### .gitignore Excludes
- Generated book files: `*.pdf`, `*.docx`, `*.epub`, `*.odt`, `*.rtf`, `*.html`
- Build artifacts: `.wrangler/`, `node_modules/`
- System files: `.DS_Store`
- Backup directories: `images_backup/`

### Reason for Exclusion
Generated files exceed GitHub's 100MB limit. Only markdown source files are tracked in git. Generated files are stored in Cloudflare R2.

## Requirements
- **pandoc** - Document conversion
- **MacTeX/XeLaTeX** - PDF generation with proper fonts
- **wrangler** (v4.43.0+) - Cloudflare R2 uploads

## Important Notes
1. **Never commit generated files** - They're too large and are regenerated automatically
2. **Build time** - Full build takes 3-5 minutes due to file sizes
3. **PDF is print-quality** - Uncompressed images, embedded fonts, designed for professional printing
4. **Book is 250+ pages** - Substantial content requiring careful pagination

## Common Tasks

### Adding a New Chapter
1. Create markdown file following naming convention: `##_chapter_name.md`
2. Add to `CHAPTERS` array in `scripts/build_book.sh`
3. Add corresponding image to `images/` directory
4. Commit changes (build will run automatically)

### Updating Metadata
Edit `scripts/metadata.yaml` with book title, author, etc.

### Troubleshooting Build
- Check pandoc installed: `pandoc --version`
- Check XeLaTeX: `/Library/TeX/texbin/xelatex --version`
- Check wrangler: `wrangler --version`
- View build output: Hook runs after commit shows progress

## File Size Considerations
Due to high-quality images, files are large:
- PDF: 95MB (print-quality, no compression)
- EPUB/DOCX/ODT: ~50MB each
- RTF: 101MB (largest, includes inline images)
- HTML: 392KB (smallest, images linked)

These sizes are intentional for print quality but exceed GitHub limits, hence the Cloudflare R2 storage solution.
